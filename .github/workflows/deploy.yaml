name: Deploy to Production
on:
  push:
    branches: [ main ]
  workflow_dispatch:
env:
  KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
jobs:
  deploy:
    name: Deploy to prd namespace
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
    - name: Configure Kubernetes cluster access
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig.yaml
        export KUBECONFIG=kubeconfig.yaml
        kubectl cluster-info
    - name: Create prd namespace if not exists
      run: |
        export KUBECONFIG=kubeconfig.yaml
        kubectl create namespace prd --dry-run=client -o yaml | kubectl apply -f -
    - name: Apply gateway manifests
      run: |
        export KUBECONFIG=kubeconfig.yaml
        if ! kubectl get gatewayclass nginx &> /dev/null; then
          kubectl apply -f ./gateway/gateway-class.yaml
        fi
        kubectl apply -f ./gateway/gateway.yaml
    - name: Apply project manifests
      run: |
        export KUBECONFIG=kubeconfig.yaml
        find ./projects -name "*.yaml" -exec kubectl apply -f {} --namespace=prd \;
    - name: Verify deployment
      run: |
        export KUBECONFIG=kubeconfig.yaml
        kubectl get all -n prd
        kubectl get gatewayclass -A
        kubectl get gateway -n prd
        kubectl get httproute -n prd
